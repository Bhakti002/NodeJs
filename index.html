<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modern To-Do List</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-content">
                <h1><i class="fa-solid fa-list-check"></i> TaskFlow</h1>
                <p>Stay organized and productive</p>
            </div>
        </header>

        <main class="container">
            <section class="add-task-section">
                <form id="taskForm" class="task-input-card">
                    <div class="input-group">
                        <input id="name" name="name" type="text" placeholder="What needs to be done?" required />
                        <select id="status" name="status">
                            <option value="Incomplete">Incomplete</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Complete">Complete</option>
                        </select>
                        <button type="submit" class="btn-add">
                            <i class="fa-solid fa-plus"></i>
                            <span>Add</span>
                        </button>
                    </div>
                </form>
            </section>

            <section class="tasks-section">
                <div class="tasks-header">
                    <h2>Your Tasks</h2>
                    <div id="task-stats" class="task-stats">
                        <span id="total-count">0 Tasks</span>
                    </div>
                </div>
                <div id="alerts"></div>
                <div id="tasksList" class="tasks-list">
                    <!-- Tasks will be rendered here as cards -->
                </div>
            </section>
        </main>
    </div>

    <script>
        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const tasksList = $('#tasksList');
        const form = $('#taskForm');
        const alerts = $('#alerts');
        const totalCount = $('#total-count');

        function showAlert(msg, type = 'success', timeout = 2500) {
            const el = document.createElement('div');
            el.className = `alert ${type}`;
            el.innerHTML = `
                <i class="fa-solid ${type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation'}"></i>
                <span>${msg}</span>
            `;
            alerts.appendChild(el);
            setTimeout(() => el.classList.add('fade-out'), timeout - 500);
            setTimeout(() => el.remove(), timeout);
        }

        async function fetchTasks() {
            try {
                const res = await fetch('/tasks');
                const json = await res.json();
                return json.data || [];
            } catch (e) {
                showAlert('Failed to load tasks', 'error');
                return [];
            }
        }

        function renderTasks(tasks) {
            tasksList.innerHTML = '';
            totalCount.textContent = `${tasks.length} Task${tasks.length === 1 ? '' : 's'}`;
            
            if (tasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="empty-state">
                        <i class="fa-solid fa-clipboard-list"></i>
                        <p>No tasks yet. Add one above!</p>
                    </div>
                `;
                return;
            }

            tasks.forEach(t => {
                const statusClass = t.status.toLowerCase().replace(' ', '-');
                const card = document.createElement('div');
                card.className = `task-card ${statusClass}`;
                card.innerHTML = `
                    <div class="task-content">
                        <h3>${escapeHtml(t.name)}</h3>
                        <span class="badge ${statusClass}">${t.status}</span>
                    </div>
                    <div class="task-actions">
                        <button class="btn-icon edit" data-id="${t.id}" title="Edit Task">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <button class="btn-icon delete" data-id="${t.id}" title="Delete Task">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                `;
                tasksList.appendChild(card);
            });
        }

        function escapeHtml(str = '') {
            return String(str).replace(/[&<>\"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'})[s]);
        }

        async function loadAndRender() {
            const tasks = await fetchTasks();
            renderTasks(tasks);
        }

        form.addEventListener('submit', async e => {
            e.preventDefault();
            const name = $('#name').value.trim();
            const status = $('#status').value;
            if (!name) return showAlert('Name is required', 'error');
            
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                const res = await fetch('/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, status })
                });
                if (!res.ok) throw new Error('Create failed');
                showAlert('Task added successfully');
                form.reset();
                loadAndRender();
            } catch (err) {
                showAlert('Failed to create task', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa-solid fa-plus"></i><span>Add</span>';
            }
        });

        document.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('button.edit');
            const delBtn = e.target.closest('button.delete');
            
            if (editBtn) {
                const id = editBtn.dataset.id;
                const card = editBtn.closest('.task-card');
                const currentName = card.querySelector('h3').textContent;
                const currentStatus = card.querySelector('.badge').textContent;
                
                const newName = prompt('Update task name:', currentName);
                if (newName === null) return;
                
                const newStatus = prompt('Update status (Incomplete, In Progress, Complete):', currentStatus);
                if (newStatus === null) return;

                try {
                    const res = await fetch(`/tasks/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName, status: newStatus })
                    });
                    if (!res.ok) throw new Error('Update failed');
                    showAlert('Task updated');
                    loadAndRender();
                } catch (err) {
                    showAlert('Failed to update task', 'error');
                }
            }
            
            if (delBtn) {
                const id = delBtn.dataset.id;
                if (!confirm('Are you sure you want to delete this task?')) return;
                
                try {
                    const res = await fetch(`/tasks/${id}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error('Delete failed');
                    showAlert('Task deleted');
                    loadAndRender();
                } catch (err) {
                    showAlert('Failed to delete task', 'error');
                }
            }
        });

        // Initialize
        loadAndRender();
    </script>
</body>
</html>